<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubOS Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme Variables */
        :root {
            --font-primary: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            --grid-gap: 16px;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --status-success: #10b981;
            --status-error: #ef4444;
            --status-warning: #f59e0b;
            --status-info: #3b82f6;
        }

        /* Dark Theme Variables */
        :root[data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent: #152F2F;
            --accent-hover: #1a3939;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #666666;
            --border-primary: #333333;
            --border-secondary: #2a2a2a;
        }

        /* Light Theme Variables */
        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --accent: #047857;
            --accent-hover: #065f46;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-primary: #e5e7eb;
            --border-secondary: #f3f4f6;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout System */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            gap: var(--grid-gap);
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-auto { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        h4 { font-size: 1rem; }

        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }

        .text-muted { color: var(--text-secondary); }
        .text-accent { color: var(--accent); }
        .text-uppercase { text-transform: uppercase; }
        .text-mono { font-family: 'Courier New', monospace; }

        /* Components */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            transition: all var(--transition-normal);
        }

        .card-hover:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 47, 47, 0.3);
        }

        .card-header {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(21, 47, 47, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #3a3a3a;
        }

        .btn-danger {
            background: var(--status-error);
        }

        .btn-full {
            width: 100%;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Theme Toggle - Minimal */
        #theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            font-family: inherit;
            transition: all var(--transition-fast);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #theme-toggle:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 2rem;
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: 2rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-item {
            padding: 0.75rem 0;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }

        /* Status Indicators */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-completed { background-color: var(--status-success); }
        .status-processing { 
            background-color: var(--status-info); 
            animation: pulse 1s infinite;
        }
        .status-failed { background-color: var(--status-error); }
        .status-pending { background-color: var(--status-warning); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 24px;
            cursor: pointer;
            transition: background var(--transition-normal);
        }

        .toggle-switch input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all var(--transition-normal);
        }

        .toggle-switch input:checked ~ .toggle-slider {
            transform: translateX(20px);
            background: white;
        }

        .toggle-switch input:checked ~ .toggle-switch {
            background: var(--accent);
        }

        /* Metric Cards */
        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Console Log */
        .console-log {
            background: var(--bg-primary);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 0.5rem;
        }

        .log-time { color: var(--text-muted); }
        .log-success { color: var(--status-success); }
        .log-error { color: var(--status-error); }
        .log-info { color: var(--text-secondary); }
        .log-warning { color: var(--status-warning); }

        /* Layer Flow */
        .layer-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem 0;
            overflow-x: auto;
        }

        .layer-node {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 140px;
            transition: all var(--transition-normal);
        }

        .layer-node.active {
            border-color: var(--status-success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
            transform: scale(1.05);
        }

        .layer-arrow {
            width: 40px;
            height: 2px;
            background: var(--accent);
            position: relative;
        }

        .layer-arrow::after {
            content: '';
            position: absolute;
            right: -6px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 6px solid var(--accent);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }

        /* Task Item */
        .task-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .task-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .task-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 3rem 0;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* API Status */
        .api-status {
            position: fixed;
            top: 1.5rem;
            right: 5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            z-index: 100;
        }

        .api-status.connected {
            border-color: var(--status-success);
        }

        .api-status.disconnected {
            border-color: var(--status-error);
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            html { font-size: 14px; }
            
            .container { padding: 1rem; }
            
            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav {
                gap: 1rem;
                padding-bottom: 0.5rem;
            }
            
            .api-status {
                top: 0.5rem;
                right: 4rem;
            }

            #theme-toggle {
                top: 0.5rem;
                right: 0.5rem;
            }
            
            .layer-flow {
                flex-direction: column;
            }
            
            .layer-arrow {
                width: 2px;
                height: 40px;
                transform: rotate(90deg);
            }
        }

        /* Role-based Visibility */
        [data-role="admin"] { display: none; }
        [data-role="operator"] { display: none; }
        
        body.role-admin [data-role="admin"] { display: block; }
        body.role-admin [data-role="operator"] { display: block; }
        body.role-operator [data-role="operator"] { display: block; }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .nav,
            .api-status,
            .btn,
            #theme-toggle {
                display: none;
            }
        }
    </style>
</head>
<body class="role-admin" data-theme="dark">
    <div class="container">
        <!-- Minimal Theme Toggle -->
        <button id="theme-toggle">DARK</button>

        <!-- API Status Indicator -->
        <div class="api-status disconnected" id="apiStatus">
            <span class="status-dot status-failed"></span>
            <span>API: <span id="apiStatusText">Checking...</span></span>
        </div>
        
        <!-- Header Component -->
        <header id="header"></header>
        
        <!-- Architecture Component -->
        <section id="architecture"></section>
        
        <!-- Navigation Component -->
        <nav id="navigation" class="nav"></nav>
        
        <!-- Content Area -->
        <main id="content"></main>
    </div>

    <script type="module">
        // Core State Management
        class StateManager {
            constructor() {
                this.state = {
                    activeTab: 'dashboard',
                    tasks: [],
                    tickets: [],
                    logs: [],
                    isProcessing: false,
                    user: {
                        role: 'admin' // viewer, operator, admin
                    },
                    api: {
                        connected: false,
                        baseUrl: 'http://localhost/api'
                    }
                };
                this.listeners = new Map();
            }

            subscribe(key, callback) {
                if (!this.listeners.has(key)) {
                    this.listeners.set(key, new Set());
                }
                this.listeners.get(key).add(callback);
            }

            unsubscribe(key, callback) {
                if (this.listeners.has(key)) {
                    this.listeners.get(key).delete(callback);
                }
            }

            setState(updates) {
                Object.assign(this.state, updates);
                Object.keys(updates).forEach(key => {
                    if (this.listeners.has(key)) {
                        this.listeners.get(key).forEach(callback => callback(this.state[key]));
                    }
                });
            }

            getState() {
                return this.state;
            }
        }

        // API Service
        class APIService {
            constructor(stateManager) {
                this.state = stateManager;
                this.baseUrl = this.state.getState().api.baseUrl;
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.baseUrl}/health`);
                    const connected = response.ok;
                    this.state.setState({ api: { ...this.state.getState().api, connected } });
                    return connected;
                } catch (error) {
                    this.state.setState({ api: { ...this.state.getState().api, connected: false } });
                    return false;
                }
            }

            async processTask(taskData) {
                const response = await fetch(`${this.baseUrl}/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            }
        }

        // Component Base Class
        class Component {
            constructor(elementId, stateManager) {
                this.element = document.getElementById(elementId);
                this.state = stateManager;
            }

            render() {
                throw new Error('render() must be implemented by subclass');
            }

            mount() {
                this.render();
            }
        }

        // Header Component
        class HeaderComponent extends Component {
            render() {
                this.element.innerHTML = `
                    <div style="border-bottom: 1px solid var(--border-primary); padding-bottom: 1.5rem; margin-bottom: 2rem;">
                        <h1 style="margin-bottom: 0.5rem;">ClubOS MISSION CONTROL</h1>
                        <div style="display: flex; gap: 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            <span>VERSION 2.0 | JULY 2025</span>
                            <span>|</span>
                            <span class="text-accent">CLUBHOUSE OPERATIONAL INTELLIGENCE</span>
                        </div>
                    </div>
                `;
            }
        }

        // Architecture Component
        class ArchitectureComponent extends Component {
            render() {
                const modules = [
                    { name: 'ClubOS', desc: 'Master system & UI interface - The full nervous system' },
                    { name: 'ClubCore', desc: 'Backend engine - Central brain routing logic' },
                    { name: 'ClubOps', desc: 'Procedural logic - Muscle memory for routine tasks' },
                    { name: 'SignalOS', desc: 'Strategic engine - Prefrontal cortex for planning' },
                    { name: 'Clubhost', desc: 'Voice enforcement - Personality filter' },
                    { name: 'CapabilityFrontier', desc: 'Guardrail layer - Pain reflex for boundaries' },
                    { name: 'Ticket Engine', desc: 'Post-processing - Reflex output & logging' },
                    { name: 'Google Drive', desc: 'Document search & retrieval integration' }
                ];

                this.element.innerHTML = `
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header text-accent">SYSTEM ARCHITECTURE - NERVOUS SYSTEM ANALOGY</div>
                        <div class="grid grid-auto">
                            ${modules.map(module => `
                                <div class="card card-hover" style="background: var(--bg-primary);">
                                    <div style="font-weight: 600; color: var(--accent); margin-bottom: 0.25rem;">${module.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${module.desc}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Navigation Component
        class NavigationComponent extends Component {
            constructor(elementId, stateManager) {
                super(elementId, stateManager);
                this.tabs = [
                    { id: 'dashboard', label: 'DASHBOARD' },
                    { id: 'process', label: 'TASK PROCESSOR' },
                    { id: 'commands', label: 'COMMAND CENTER' },
                    { id: 'operations', label: 'OPERATIONS' },
                    { id: 'tickets', label: 'TICKET ENGINE' },
                    { id: 'history', label: 'HISTORY' },
                    { id: 'versions', label: 'VERSION CONTROL' }
                ];
            }

            render() {
                const activeTab = this.state.getState().activeTab;
                this.element.innerHTML = this.tabs.map(tab => `
                    <div class="nav-item ${tab.id === activeTab ? 'active' : ''}" data-tab="${tab.id}">
                        ${tab.label}
                    </div>
                `).join('');

                // Add event listeners
                this.element.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => this.handleTabClick(e));
                });
            }

            handleTabClick(e) {
                const tabId = e.target.dataset.tab;
                this.state.setState({ activeTab: tabId });
            }
        }

        // Dashboard Component
        class DashboardComponent extends Component {
            render() {
                const { tasks, tickets, logs } = this.state.getState();
                
                this.element.innerHTML = `
                    <!-- Metrics -->
                    <div class="grid grid-auto" style="margin-bottom: 2rem;">
                        ${this.renderMetricCard('HEALTHY', 'System Status', 'status-completed')}
                        ${this.renderMetricCard(tasks.filter(t => t.status === 'processing').length, 'Active Tasks')}
                        ${this.renderMetricCard(tasks.filter(t => t.status === 'completed').length, 'Completed Today')}
                        ${this.renderMetricCard(tickets.length, 'Tickets Generated')}
                        ${this.renderMetricCard('92%', 'Success Rate')}
                        ${this.renderMetricCard('2.3s', 'Avg Processing Time')}
                    </div>
                    
                    <!-- System Logs -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">System Logs</div>
                        <div class="console-log" id="logContainer">
                            ${logs.map(log => this.renderLogEntry(log)).join('')}
                        </div>
                    </div>
                    
                    <!-- Recent Tasks -->
                    <div class="card">
                        <div class="card-header">Recent Tasks</div>
                        <div id="recentTasks">
                            ${tasks.length === 0 
                                ? '<div class="empty-state">No recent tasks. Create a new request to get started.</div>'
                                : tasks.slice(0, 5).map(task => this.renderTaskItem(task)).join('')
                            }
                        </div>
                    </div>
                `;
            }

            renderMetricCard(value, label, statusClass = '') {
                return `
                    <div class="metric-card">
                        <div class="metric-value">
                            ${statusClass ? `<span class="status-dot ${statusClass}"></span>` : ''}${value}
                        </div>
                        <div class="metric-label">${label}</div>
                    </div>
                `;
            }

            renderLogEntry(log) {
                return `
                    <div class="log-entry">
                        <span class="log-time">[${log.time}]</span> 
                        <span class="log-${log.type}">${log.message}</span>
                    </div>
                `;
            }

            renderTaskItem(task) {
                return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-title">
                                <span class="status-dot status-${task.status}"></span>
                                ${task.task.substring(0, 60)}...
                            </div>
                            <div class="task-meta">
                                ${task.priority.toUpperCase()} • ${task.operation.toUpperCase()} • 
                                Confidence: ${(task.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Task Processor Component
        class TaskProcessorComponent extends Component {
            render() {
                this.element.innerHTML = `
                    <div class="card">
                        <div class="card-header">COGNITIVE REQUEST BUILDER</div>
                        
                        <!-- Task Description -->
                        <div class="form-group">
                            <label class="form-label">Task Description</label>
                            <textarea id="taskInput" class="form-textarea" placeholder="Describe the task to process..."></textarea>
                        </div>
                        
                        <!-- Priority and Type -->
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select id="prioritySelect" class="form-select">
                                    <option value="low">LOW</option>
                                    <option value="medium" selected>MEDIUM</option>
                                    <option value="high">HIGH</option>
                                    <option value="critical">CRITICAL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Operation Type</label>
                                <select id="operationSelect" class="form-select">
                                    <option value="general">GENERAL</option>
                                    <option value="pricing">PRICING</option>
                                    <option value="sop">SOP</option>
                                    <option value="installation">INSTALLATION</option>
                                    <option value="partnership">PARTNERSHIP</option>
                                    <option value="simulation">SIMULATION</option>
                                    <option value="strategy">STRATEGY</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Location (conditional) -->
                        <div id="locationGroup" class="form-group" style="display: none;">
                            <label class="form-label">Location</label>
                            <input id="locationInput" type="text" class="form-input" placeholder="e.g., River Oaks">
                        </div>
                        
                        <!-- Options -->
                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin: 1.25rem 0;">
                            ${this.renderToggle('simulationCheck', 'REQUIRE SIMULATION')}
                            ${this.renderToggle('llmCheck', 'USE LLM')}
                            ${this.renderToggle('escalationCheck', 'ALLOW ESCALATION', true)}
                            ${this.renderToggle('ticketCheck', 'GENERATE TICKET', true)}
                            ${this.renderToggle('driveCheck', 'SEARCH GOOGLE DRIVE')}
                        </div>
                        
                        <!-- Submit Button -->
                        <button id="submitBtn" class="btn btn-full">
                            PROCESS REQUEST
                        </button>
                    </div>
                    
                    <!-- Layer Processing Flow -->
                    <div id="layerFlowCard" class="card" style="display: none; margin-top: 1.5rem;">
                        <div class="card-header">Layer Processing Flow</div>
                        <div class="layer-flow">
                            ${this.renderLayerFlow()}
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="resultsCard" class="card" style="display: none; margin-top: 1.5rem;">
                        <div class="card-header">Processing Result</div>
                        <div id="resultsContent"></div>
                    </div>
                `;

                // Add event listeners
                this.attachEventListeners();
            }

            renderToggle(id, label, checked = false) {
                return `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="${id}" ${checked ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-size: 0.875rem;">${label}</span>
                    </div>
                `;
            }

            renderLayerFlow() {
                const layers = [
                    { id: 'capability', name: 'CAPABILITY<br>FRONTIER' },
                    { id: 'clubops', name: 'CLUBOPS' },
                    { id: 'signalos', name: 'SIGNAL OS' },
                    { id: 'clubhost', name: 'CLUBHOST' },
                    { id: 'ticket', name: 'TICKET<br>ENGINE' }
                ];

                return layers.map((layer, index) => `
                    <div id="layer-${layer.id}" class="layer-node">${layer.name}</div>
                    ${index < layers.length - 1 ? '<div class="layer-arrow"></div>' : ''}
                `).join('');
            }

            attachEventListeners() {
                const operationSelect = document.getElementById('operationSelect');
                const submitBtn = document.getElementById('submitBtn');

                operationSelect?.addEventListener('change', (e) => {
                    const locationGroup = document.getElementById('locationGroup');
                    locationGroup.style.display = e.target.value !== 'general' ? 'block' : 'none';
                });

                submitBtn?.addEventListener('click', () => this.handleSubmit());
            }

            async handleSubmit() {
                const taskInput = document.getElementById('taskInput').value.trim();
                if (!taskInput || this.state.getState().isProcessing) return;

                this.state.setState({ isProcessing: true });
                
                // Show processing UI
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = '<span class="spinner"></span> PROCESSING...';
                submitBtn.disabled = true;

                document.getElementById('layerFlowCard').style.display = 'block';
                document.getElementById('resultsCard').style.display = 'none';

                // Animate layers
                const layers = ['capability', 'clubops', 'signalos', 'clubhost', 'ticket'];
                for (const layer of layers) {
                    document.getElementById(`layer-${layer}`).classList.add('active');
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Process task
                try {
                    const api = new APIService(this.state);
                    const result = await api.processTask({
                        task: taskInput,
                        priority: document.getElementById('prioritySelect').value,
                        location: document.getElementById('locationInput').value || null
                    });

                    this.handleTaskResult(result);
                } catch (error) {
                    this.handleTaskError(error);
                } finally {
                    submitBtn.innerHTML = 'PROCESS REQUEST';
                    submitBtn.disabled = false;
                    this.state.setState({ isProcessing: false });
                }
            }

            handleTaskResult(result) {
                // Add task to state
                const tasks = this.state.getState().tasks;
                const newTask = {
                    id: result.request_id,
                    task: document.getElementById('taskInput').value,
                    status: result.response.status || 'completed',
                    priority: document.getElementById('prioritySelect').value,
                    operation: document.getElementById('operationSelect').value,
                    confidence: result.response.confidence || 0.95,
                    timestamp: new Date()
                };
                
                this.state.setState({ tasks: [newTask, ...tasks] });

                // Show results
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('resultsContent').innerHTML = `
                    <div class="grid grid-3" style="margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--status-success);">COMPLETED</div>
                            <div class="text-xs text-muted text-uppercase">Status</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: 1.5rem; font-weight: 600;">${Math.round(result.response.confidence * 100)}%</div>
                            <div class="text-xs text-muted text-uppercase">Confidence</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: 1.5rem; font-weight: 600;">${result.response.time_estimate || '2.3s'}</div>
                            <div class="text-xs text-muted text-uppercase">Processing Time</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-secondary); border-radius: var(--radius-md); padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">RECOMMENDATION</h4>
                        <div class="text-mono">
                            ${Array.isArray(result.response.recommendation) 
                                ? result.response.recommendation.map(step => `<div>• ${step}</div>`).join('')
                                : `<div>${result.response.recommendation}</div>`}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="window.app.resetForm()">NEW REQUEST</button>
                        <button class="btn">SAVE RESULT</button>
                    </div>
                `;
            }

            handleTaskError(error) {
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('resultsContent').innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--status-error); border-radius: var(--radius-md); padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--status-error);">Processing Failed</h4>
                        <div>${error.message}</div>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="window.app.resetForm()">TRY AGAIN</button>
                `;
            }
        }

        // Logger Service
        class Logger {
            constructor(stateManager) {
                this.state = stateManager;
            }

            log(message, type = 'info') {
                const logs = this.state.getState().logs;
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                this.state.setState({ 
                    logs: [...logs, { time, message, type }].slice(-100) // Keep last 100 logs
                });
            }
        }

        // Main Application
        class ClubOSApp {
            constructor() {
                this.state = new StateManager();
                this.logger = new Logger(this.state);
                this.api = new APIService(this.state);
                this.components = new Map();
                
                this.initializeComponents();
                this.attachGlobalListeners();
                this.start();
            }

            initializeComponents() {
                // Register components
                this.components.set('header', new HeaderComponent('header', this.state));
                this.components.set('architecture', new ArchitectureComponent('architecture', this.state));
                this.components.set('navigation', new NavigationComponent('navigation', this.state));
                
                // Subscribe to state changes
                this.state.subscribe('activeTab', (activeTab) => this.handleTabChange(activeTab));
                this.state.subscribe('api', (api) => this.updateAPIStatus(api));
                this.state.subscribe('logs', () => this.updateLogs());
            }

            attachGlobalListeners() {
                // Set user role based on body class
                const bodyClasses = document.body.classList;
                if (bodyClasses.contains('role-admin')) {
                    this.state.setState({ user: { role: 'admin' } });
                } else if (bodyClasses.contains('role-operator')) {
                    this.state.setState({ user: { role: 'operator' } });
                } else {
                    this.state.setState({ user: { role: 'viewer' } });
                }

                // Expose app globally for inline event handlers
                window.app = this;
            }

            start() {
                // Mount static components
                this.components.get('header').mount();
                this.components.get('architecture').mount();
                this.components.get('navigation').mount();
                
                // Initialize first tab
                this.handleTabChange('dashboard');
                
                // Start API monitoring
                this.logger.log('ClubOS Mission Control initialized', 'success');
                this.checkAPIConnection();
                setInterval(() => this.checkAPIConnection(), 30000);
            }

            handleTabChange(activeTab) {
                const contentEl = document.getElementById('content');
                
                // Update navigation
                this.components.get('navigation').render();
                
                // Render appropriate content
                switch (activeTab) {
                    case 'dashboard':
                        const dashboard = new DashboardComponent('content', this.state);
                        dashboard.mount();
                        break;
                    case 'process':
                        const processor = new TaskProcessorComponent('content', this.state);
                        processor.mount();
                        break;
                    default:
                        contentEl.innerHTML = `
                            <div class="card">
                                <div class="card-header">${activeTab.toUpperCase()}</div>
                                <div class="empty-state">Component coming soon...</div>
                            </div>
                        `;
                }
            }

            async checkAPIConnection() {
                this.logger.log('Checking API connection...', 'info');
                const connected = await this.api.checkConnection();
                this.logger.log(
                    connected ? 'API connection verified' : 'API connection failed',
                    connected ? 'success' : 'error'
                );
            }

            updateAPIStatus(api) {
                const statusEl = document.getElementById('apiStatus');
                const statusTextEl = document.getElementById('apiStatusText');
                
                statusEl.classList.toggle('connected', api.connected);
                statusEl.classList.toggle('disconnected', !api.connected);
                statusEl.querySelector('.status-dot').className = `status-dot status-${api.connected ? 'completed' : 'failed'}`;
                statusTextEl.textContent = api.connected ? 'Connected' : 'Disconnected';
            }

            updateLogs() {
                const logContainer = document.getElementById('logContainer');
                if (logContainer) {
                    const logs = this.state.getState().logs;
                    logContainer.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span> 
                            <span class="log-${log.type}">${log.message}</span>
                        </div>
                    `).join('');
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }

            resetForm() {
                document.getElementById('taskInput').value = '';
                document.getElementById('prioritySelect').value = 'medium';
                document.getElementById('operationSelect').value = 'general';
                document.getElementById('locationInput').value = '';
                document.getElementById('locationGroup').style.display = 'none';
                
                // Reset toggles
                ['simulationCheck', 'llmCheck', 'driveCheck'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
                
                ['escalationCheck', 'ticketCheck'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = true;
                });
                
                // Hide results
                document.getElementById('layerFlowCard').style.display = 'none';
                document.getElementById('resultsCard').style.display = 'none';
                
                // Reset layer animations
                document.querySelectorAll('.layer-node').forEach(node => {
                    node.classList.remove('active');
                });
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            new ClubOSApp();
        });

        // Minimal Theme Toggle - Just 8 lines!
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const root = document.documentElement;
            const current = root.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', next);
            document.getElementById('theme-toggle').textContent = next.toUpperCase();
            localStorage.setItem('clubos-theme', next);
        });

        // Load saved theme on startup
        (function() {
            const saved = localStorage.getItem('clubos-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            document.getElementById('theme-toggle').textContent = saved.toUpperCase();
        })();
    </script>
</body>
</html>
